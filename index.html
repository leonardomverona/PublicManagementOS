<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Public Management OS 2.0</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

    <script src="https://unpkg.com/bpmn-js@17.0.2/dist/bpmn-modeler.development.js"></script>

    <style>
        /* =========================================== */
        /* == Public Management OS 2.0 - Core Styles == */
        /* =========================================== */

        /* --- Variáveis Globais e Tema --- */
        :root {
            /* Tema Sonoma Claro (Padrão) */
            --accent-light: #007AFF; --accent-light-rgb: 0, 122, 255;
            --background-light: #f0f0f5; --background-light-rgb: 240,240,245;
            --text-light: #1d1d1f;
            --secondary-text-light: #6e6e73;
            --window-bg-light: rgba(248, 248, 250, 0.75); --window-bg-light-rgb: 248,248,250;
            --toolbar-bg-light: rgba(240, 240, 245, 0.70);
            --button-bg-light: rgba(225, 225, 230, 0.98);
            --input-bg-light: #ffffff;
            --input-border-light: #d1d1d6;
            --separator-light: rgba(60, 60, 67, 0.29);

            /* Tema Sonoma Escuro */
            --accent-dark: #0A84FF; --accent-dark-rgb: 10, 132, 255;
            --background-dark: #121212; --background-dark-rgb: 18,18,18;
            --text-dark: #f5f5f7;
            --secondary-text-dark: #8a8a8e;
            --window-bg-dark: rgba(32, 32, 34, 0.75); --window-bg-dark-rgb: 32,32,34;
            --toolbar-bg-dark: rgba(44, 44, 46, 0.70);
            --button-bg-dark: rgba(72, 72, 74, 0.98);
            --input-bg-dark: #2c2c2e;
            --input-border-dark: #545458;
            --separator-dark: rgba(84, 84, 88, 0.65);

            /* Variáveis Ativas (Inicializadas para o tema claro) */
            --accent: var(--accent-light); --accent-rgb: var(--accent-light-rgb);
            --background: var(--background-light); --background-rgb: var(--background-light-rgb);
            --text-primary: var(--text-light);
            --text-secondary: var(--secondary-text-light);
            --bg-window: var(--window-bg-light); --bg-window-rgb: var(--window-bg-light-rgb);
            --bg-toolbar: var(--toolbar-bg-light);
            --bg-button: var(--button-bg-light);
            --bg-input: var(--input-bg-light);
            --border-input: var(--input-border-light);
            --border-separator: var(--separator-light);
            --accent-translucent: rgba(var(--accent-rgb), 0.15);

            /* Constantes de Layout e Estilo */
            --system-blur: blur(28px);
            --taskbar-height: 48px;
            --dock-item-size: 58px;
            --dock-padding: 10px;
            --dock-gap: 14px;
            --radius-window: 14px;
            --radius-button: 8px;
            --shadow-window: 0 20px 50px rgba(0,0,0,0.35), 0 8px 16px rgba(0,0,0,0.25);
            --font-system: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* --- Tema Escuro --- */
        body.dark-mode {
            --accent: var(--accent-dark); --accent-rgb: var(--accent-dark-rgb);
            --background: var(--background-dark); --background-rgb: var(--background-dark-rgb);
            --text-primary: var(--text-dark);
            --text-secondary: var(--secondary-text-dark);
            --bg-window: var(--window-bg-dark); --bg-window-rgb: var(--window-bg-dark-rgb);
            --bg-toolbar: var(--toolbar-bg-dark);
            --bg-button: var(--button-bg-dark);
            --bg-input: var(--input-bg-dark);
            --border-input: var(--input-border-dark);
            --border-separator: var(--separator-dark);
            --accent-translucent: rgba(var(--accent-rgb), 0.2);
        }

        /* --- Reset e Base --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-system); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        html { font-size: 16px; }
        body {
            background-color: var(--background);
            background-image: url('https://raw.githubusercontent.com/leonardomverona/PublicManagementOS/main/Public%20Management%20OS.png');
            background-size: cover; background-position: center; background-attachment: fixed;
            height: 100vh; overflow: hidden; color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease, background-image 0.5s ease;
            user-select: none;
        }
        body.dragging, body.resizing { cursor: grabbing !important; }

        /* --- Interface de Login --- */
        #login-container {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100vh; text-align: center; backdrop-filter: blur(10px) brightness(0.8); padding: 20px;
        }
        #login-container h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); color: #fff; }
        #login-container p { font-size: 1.2em; margin-bottom: 30px; color: #f0f0f0; text-shadow: 0 1px 3px rgba(0,0,0,0.3);}
        .login-form {
            background-color: var(--window-bg-light); padding: 30px; border-radius: var(--radius-window); box-shadow: var(--shadow-window);
            width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 15px;
        }
        body.dark-mode .login-form { background-color: var(--window-bg-dark); }
        .login-form input {
            width: 100%; padding: 12px; font-size: 1em; border: 1px solid var(--border-input);
            background: var(--bg-input); color: var(--text-primary); border-radius: var(--radius-button);
        }
        .login-form .app-button { width: 100%; }
        .login-form-toggle { color: var(--accent); cursor: pointer; font-size: 0.9em; text-decoration: none; }
        .login-form-toggle:hover { text-decoration: underline; }

        /* --- Controle de Visibilidade Login/OS --- */
        body.logged-out #os-container { display: none; }
        body.logged-in #login-container { display: none; }

        /* --- Estrutura Principal do SO --- */
        #os-container { position: relative; width: 100%; height: 100vh; }
        #desktop { height: calc(100vh - var(--taskbar-height)); position: relative; overflow: hidden; }

        /* --- Barra de Tarefas (Superior) --- */
        .taskbar {
            position: fixed; top: 0; width: 100%; height: var(--taskbar-height);
            background: var(--bg-toolbar); backdrop-filter: var(--system-blur); -webkit-backdrop-filter: var(--system-blur);
            display: flex; align-items: center; padding: 0 15px;
            border-bottom: 1px solid var(--border-separator); z-index: 2000;
            justify-content: space-between;
        }
        .taskbar__left, .taskbar__right { display: flex; align-items: center; gap: 8px; }
        .taskbar__center { flex-grow: 1; display: flex; justify-content: center; }
        .taskbar__tasks { display:flex; gap:8px; height:100%; align-items:center; overflow-x: auto; padding: 0 10px; }
        .taskbar__item {
            padding: 6px 12px; border-radius: var(--radius-button); background: var(--bg-button);
            color: var(--text-primary); cursor: pointer; transition: all 0.2s ease;
            display:flex; align-items:center; gap:6px; height: calc(var(--taskbar-height) - 16px);
            font-size: 0.9em; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            border: 1px solid transparent;
        }
        .taskbar__item:hover { filter: brightness(0.95); }
        .taskbar__item.active { background: var(--accent); color: white; font-weight: 600; }
        .taskbar__item .icon { font-size: 1.1em; }
        .clock { font-weight: 500; font-variant-numeric: tabular-nums; font-size: 0.95em; }
        .user-profile { display: flex; align-items: center; gap: 10px; }
        .user-profile__avatar { font-size: 24px; }
        .user-profile__name { font-weight: 500; font-size: 0.9em; }
        .user-profile__logout { font-size: 0.85em !important; padding: 6px 12px !important; }

        /* --- Dock de Aplicativos (Inferior) --- */
        .dock {
            position: fixed; bottom: 10px; left: 50%;
            transform: translateX(-50%); display: flex; align-items: flex-end; gap: var(--dock-gap);
            background: rgba(var(--bg-window-rgb), 0.4); border: 1px solid rgba(255, 255, 255, 0.2);
            padding: var(--dock-padding); border-radius: 22px; z-index: 2001;
            backdrop-filter: var(--system-blur); -webkit-backdrop-filter: var(--system-blur);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3); perspective: 800px;
        }
        .dock__item {
            width: var(--dock-item-size); height: var(--dock-item-size); background: transparent; border-radius: 16px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            font-size: calc(var(--dock-item-size) * 0.6);
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), filter 0.2s ease;
        }
        .dock__item:hover {
            transform: scale(1.4) translateY(-15px);
        }
        .dock__item.active::after {
            content: ''; position: absolute; bottom: -8px; width: 6px; height: 6px;
            border-radius: 50%; background-color: var(--text-secondary);
        }

        /* --- Estilo de Janelas --- */
        .window {
            position: absolute; background: var(--bg-window);
            border-radius: var(--radius-window); box-shadow: var(--shadow-window);
            min-width: 400px; min-height: 300px;
            display: flex; flex-direction: column;
            transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden; border: 1px solid var(--border-separator);
            backdrop-filter: var(--system-blur); -webkit-backdrop-filter: var(--system-blur);
            transform-origin: bottom center;
        }
        .window.active { border-color: rgba(var(--accent-rgb), 0.6); box-shadow: var(--shadow-window), 0 0 0 1px rgba(var(--accent-rgb), 0.5); }
        .window.maximized {
            width: 100% !important; height: calc(100vh - var(--taskbar-height)) !important;
            top: var(--taskbar-height) !important; left: 0 !important; border-radius: 0;
        }
        .window.minimized {
            transform: translateY(calc(100vh)) scale(0.1); opacity: 0; pointer-events: none;
        }
        /* Animação de abertura */
        @keyframes windowOpen {
            from { transform: scale(0.9) translateY(40px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        .window.opening { animation: windowOpen 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Barra de Título da Janela */
        .window__titlebar {
            height: 44px; padding: 0 12px; color: var(--text-primary);
            display: flex; align-items: center; justify-content: flex-start;
            position: relative; cursor: grab; user-select: none; flex-shrink: 0;
        }
        .window.dragging .window__titlebar { cursor: grabbing; }
        .window__controls { display:flex; gap:8px; align-items: center; }
        .window__title-text {
            flex-grow: 1; text-align: center; font-size: 0.9em; font-weight: 600;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding: 0 20px;
        }
        .window-control {
            width: 12px; height: 12px; border: none; border-radius: 50%; cursor:pointer;
            transition:filter 0.15s ease; text-indent: -9999px;
        }
        .window-control.close { background-color: #ff5f57; }
        .window-control.minimize { background-color: #ffbd2e; }
        .window-control.maximize { background-color: #28c940; }
        .window-control:hover { filter: brightness(0.85); }

        .window__content { flex:1; overflow:auto; display: flex; flex-direction: column; border-top: 1px solid var(--border-separator); }
        .window__resize-handle { width: 16px; height: 16px; position: absolute; bottom: 0; right: 0; cursor: se-resize; z-index: 1; }
        .window.maximized .window__resize-handle { display: none; }

        /* --- Estilos Comuns para Aplicativos --- */
        .app-input, .app-textarea, .app-select {
            width: 100%; padding: 9px 12px; margin-bottom: 12px; border-radius: var(--radius-button);
            border: 1px solid var(--border-input); background-color: var(--bg-input);
            color: var(--text-primary); font-size: 0.95em; transition: all 0.2s ease;
        }
        .app-input:focus, .app-textarea:focus, .app-select:focus {
            border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-translucent); outline:none;
        }
        .app-textarea { min-height: 80px; line-height: 1.5; resize: vertical; }
        .app-button {
            padding: 9px 16px; border-radius: var(--radius-button); border: none;
            background: var(--accent); color: white; cursor: pointer;
            font-weight: 600; font-size:0.9em; transition: filter 0.15s ease, transform 0.1s ease;
        }
        .app-button:hover { filter: brightness(1.1); }
        .app-button:active { transform: scale(0.98); }
        .app-button.secondary { background-color: var(--bg-button); color: var(--text-primary); border: 1px solid var(--border-input); }
        .app-button.danger { background-color: #ff453a; color:white; }
        .app-toolbar {
            display:flex; gap:8px; padding:10px; background:var(--bg-toolbar);
            border-bottom:1px solid var(--border-separator); flex-wrap:wrap; align-items: center; flex-shrink: 0;
        }
        .app-toolbar .app-button, .app-toolbar .app-select { font-size: 0.85em; padding: 6px 9px; margin-bottom: 0; }
        .app-table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin-top: 10px; }
        .app-table th, .app-table td { border: 1px solid var(--border-separator); padding: 8px; text-align: left; }
        .app-table th { background-color: var(--bg-button); font-weight: 600; }
        .action-button { font-size:0.8em !important; padding: 4px 8px !important; }

        /* --- Menu de Contexto --- */
        .context-menu {
            position: fixed; background: rgba(var(--bg-window-rgb), 0.85); backdrop-filter: var(--system-blur);
            border-radius: var(--radius-button); box-shadow: var(--shadow-window); padding: 6px; z-index: 10000;
            display: none; border: 1px solid var(--border-separator); min-width: 250px;
        }
        .context-menu__item {
            padding: 8px 14px; cursor: pointer; transition: background-color 0.1s ease;
            color: var(--text-primary); font-size: 0.9em; border-radius: 5px;
            display:flex; align-items:center; gap: 10px;
        }
        .context-menu__item:hover { background: var(--accent); color: white !important; }
        .context-menu__item i { width: 16px; opacity: 0.7; margin-right: 4px; }
        .context-menu__item:hover i { opacity: 1; }
        .context-menu__separator { height: 1px; background-color: var(--border-separator); margin: 6px 4px; }

        /* --- Notificações --- */
        #notification-center {
            position:fixed; top: calc(var(--taskbar-height) + 10px); right: 20px;
            width: 320px; max-height: 400px; display: flex; flex-direction: column;
            gap: 10px; z-index:3000; pointer-events: none;
        }
        .notification {
            background:rgba(var(--bg-window-rgb), 0.9); backdrop-filter: var(--system-blur);
            color: var(--text-primary); padding:12px 20px; border-radius: var(--radius-button);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-size: 0.95em;
            opacity: 0; transform: translateX(20px); transition: all 0.4s ease;
            pointer-events: all;
        }
        .notification.show { opacity: 1; transform: translateX(0); }

        /* --- Estilos Específicos de Aplicativos (Atualização 2.0) --- */

        /* App: Explorador de Arquivos (com Pastas) */
        .file-explorer { display:flex; height:100%; }
        .file-explorer__sidebar { width:240px; border-right:1px solid var(--border-separator); padding:10px; overflow-y:auto; }
        .file-explorer__main { flex:1; padding:12px; overflow-y: auto; }
        .file-explorer__breadcrumb { margin-bottom: 12px; font-size: 0.95em; color: var(--text-secondary); }
        .file-explorer__grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; }
        .file-explorer__item {
            display: flex; flex-direction: column; align-items: center; text-align: center;
            padding: 10px; border-radius: var(--radius-button); cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .file-explorer__item:hover { background-color: var(--accent-translucent); }
        .file-explorer__item.selected { background-color: var(--accent); color: white; }
        .file-explorer__item-icon { font-size: 3em; margin-bottom: 8px; width: 60px; height: 60px; line-height: 60px; }
        .file-explorer__item-name {
            font-size: 0.85em; width: 100%; word-wrap: break-word;
            line-height: 1.3; max-height: 2.6em; overflow: hidden;
        }
        #file-explorer-context-menu .context-menu__item input {
            background: transparent; border: none; color: inherit; font: inherit;
        }

        /* App: Modelador BPMN Visual */
        .bpmn-modeler-app { display: flex; flex-direction: column; height: 100%; }
        .bpmn-modeler-app .app-toolbar { flex-shrink: 0; }
        .bpmn-modeler-app .bpmn-canvas { flex-grow: 1; background-color: var(--bg-input); }
        /* Estilos do bpmn-js são injetados pela biblioteca, mas podemos sobrepô-los */
        .bjs-container { background: var(--bg-input) !important; }
        .djs-palette { background: var(--bg-toolbar) !important; border-right: 1px solid var(--border-separator) !important; }
        .djs-palette .entry:hover { background: var(--accent-translucent) !important; }

        /* App: Diagrama de Ishikawa Visual */
        .ishikawa-diagram-app { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .ishikawa-diagram-app .app-toolbar { flex-shrink: 0; }
        .ishikawa-diagram__viewport { flex-grow: 1; overflow: auto; background-color: var(--bg-input); position: relative; }
        .ishikawa-diagram__svg { display: block; min-width: 100%; min-height: 100%; }
        .ishikawa-diagram__svg .spine { stroke: var(--text-primary); stroke-width: 3; marker-end: url(#arrowhead); }
        .ishikawa-diagram__svg .branch { stroke: var(--text-secondary); stroke-width: 2; }
        .ishikawa-diagram__svg .label-group { cursor: move; }
        .ishikawa-diagram__svg .label-box { fill: var(--bg-button); stroke: var(--border-input); }
        .ishikawa-diagram__svg .label-text { fill: var(--text-primary); font-size: 12px; user-select: none; }
        .ishikawa-diagram__svg .label-text.effect { font-weight: bold; font-size: 14px; }
        .ishikawa-diagram__svg .label-text.category { font-style: italic; }
        .ishikawa-diagram__svg .label-box.selected { stroke: var(--accent); stroke-width: 2px; }

        /* App: Configurações */
        .settings-app { display: flex; height: 100%; }
        .settings__sidebar {
            width: 200px; padding: 15px; border-right: 1px solid var(--border-separator);
            background-color: rgba(var(--bg-window-rgb), 0.5);
        }
        .settings__nav-item {
            padding: 10px; border-radius: var(--radius-button); cursor: pointer;
            margin-bottom: 5px; font-weight: 500; display: flex; align-items: center; gap: 10px;
        }
        .settings__nav-item.active { background-color: var(--accent); color: white; }
        .settings__content { flex-grow: 1; padding: 25px; overflow-y: auto; }
        .settings__pane { display: none; }
        .settings__pane.active { display: block; }
        .settings__section { margin-bottom: 30px; }
        .settings__section h3 { margin-bottom: 15px; border-bottom: 1px solid var(--border-separator); padding-bottom: 8px; }
        .settings__color-palette { display: flex; flex-wrap: wrap; gap: 12px; }
        .settings__color-option {
            width: 32px; height: 32px; border-radius: 50%; cursor: pointer;
            border: 3px solid transparent; transition: all 0.2s ease;
        }
        .settings__color-option.selected { border-color: var(--text-primary); }

        /* --- Impressão --- */
        @media print {
            body { background: #FFF !important; color: #000 !important; }
            .taskbar, .dock, .context-menu, #notification-center { display: none !important; }
            body.printing > *:not(.window--printing) { display: none !important; }
            .window--printing {
                position: static !important; width: 100% !important; height: auto !important;
                box-shadow: none !important; border: none !important; overflow: visible !important;
                background: #FFF !important; backdrop-filter: none !important;
            }
            .window--printing .window__titlebar, .window--printing .window__resize-handle,
            .window--printing .app-toolbar button:not([data-action="export-pdf"]) { display: none !important; }
            .window--printing .window__content { overflow: visible !important; height: auto !important; }
        }
    </style>
</head>
<body class="logged-out">

    <div id="login-container">
        <h1>Public Management OS 2.0</h1>
        <p>Acesse a nova geração de ferramentas para gestão pública.</p>
        <div class="login-form">
            <input type="email" id="email-input" placeholder="E-mail" required>
            <input type="password" id="password-input" placeholder="Senha" required>
            <button id="login-btn" class="app-button">Entrar</button>
            <button id="register-btn" class="app-button secondary">Criar Conta</button>
            <span id="login-error" style="color: red; font-size: 0.9em; text-align: center; display: none;"></span>
            <a href="#" id="forgot-password-link" class="login-form-toggle" style="text-align: center; margin-top: 10px;">Esqueceu a senha?</a>
        </div>
    </div>

    <div id="os-container">
        <header class="taskbar" id="taskbar">
            <div class="taskbar__left">
                <i class="fas fa-rocket" style="color: var(--accent); font-size: 1.5em; margin-right: 5px;"></i>
                <span style="font-weight: bold;">PMOS 2.0</span>
            </div>
            <div class="taskbar__center">
                <div class="taskbar__tasks" id="taskbar-tasks"></div>
            </div>
            <div class="taskbar__right">
                <button class="app-button secondary" id="stage-manager-toggle" title="Organizador Visual" style="padding: 6px 10px;">🔳</button>
                <div class="clock" id="clock">00:00</div>
                <div class="user-profile" id="user-profile" style="display: none;">
                    <span class="user-profile__avatar">👤</span>
                    <span class="user-profile__name" id="user-profile-name"></span>
                    <button id="logout-btn" class="app-button secondary user-profile__logout" title="Sair">Sair</button>
                </div>
            </div>
        </header>

        <main id="desktop"></main>

        <nav class="dock" id="app-dock"></nav>

        <div id="notification-center"></div>

        <div class="context-menu" id="desktop-context-menu"></div>
        <div class="context-menu" id="file-explorer-context-menu"></div>
    </div>

    <template id="template-app-file-explorer">
        <div class="app-toolbar">
            <button data-action="go-back" class="app-button secondary" title="Voltar"><i class="fas fa-arrow-left"></i></button>
            <button data-action="refresh" class="app-button secondary" title="Atualizar"><i class="fas fa-sync-alt"></i></button>
            <span id="breadcrumb" class="file-explorer__breadcrumb" style="margin-left: 15px;"></span>
            <button data-action="create-folder" class="app-button" style="margin-left: auto;"><i class="fas fa-folder-plus"></i> Nova Pasta</button>
        </div>
        <div class="file-explorer__main">
            <div class="file-explorer__grid"></div>
        </div>
    </template>

    <template id="template-app-default">
        <div class="app-toolbar">
            <button data-action="save" class="app-button" title="Salvar (Ctrl+S)"><i class="fas fa-save"></i> Salvar</button>
            <button data-action="save-as" class="app-button secondary" title="Salvar Como..."><i class="fas fa-file-export"></i> Salvar Como</button>
            <button data-action="export-pdf" class="app-button secondary" title="Exportar como PDF"><i class="fas fa-file-pdf"></i> PDF</button>
        </div>
        <div class="app-content-area" style="padding: 15px; overflow-y: auto;">
            </div>
    </template>

    <template id="template-app-bpmn-modeler">
        <div class="app-toolbar">
            <button data-action="save" class="app-button" title="Salvar (Ctrl+S)"><i class="fas fa-save"></i> Salvar</button>
            <button data-action="save-as" class="app-button secondary" title="Salvar Como..."><i class="fas fa-file-export"></i> Salvar Como</button>
            <button data-action="export-svg" class="app-button secondary" title="Exportar como SVG"><i class="fas fa-image"></i> Exportar SVG</button>
        </div>
        <div class="bpmn-canvas" style="height: 100%;"></div>
    </template>

    <template id="template-app-ishikawa-diagram">
        <div class="app-toolbar">
            <button data-action="save" class="app-button" title="Salvar (Ctrl+S)"><i class="fas fa-save"></i> Salvar</button>
            <button data-action="save-as" class="app-button secondary" title="Salvar Como..."><i class="fas fa-file-export"></i> Salvar Como</button>
            <button data-action="add-cause" class="app-button secondary"><i class="fas fa-plus"></i> Adicionar Causa</button>
            <button data-action="remove-selected" class="app-button danger"><i class="fas fa-trash"></i> Remover Selecionado</button>
            <button data-action="export-svg" class="app-button secondary" title="Exportar como SVG"><i class="fas fa-image"></i> Exportar SVG</button>
        </div>
        <div class="ishikawa-diagram__viewport">
            <svg class="ishikawa-diagram__svg">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="var(--text-primary)" />
                    </marker>
                </defs>
            </svg>
        </div>
    </template>

    <template id="template-app-settings">
        <div class="settings__sidebar">
            <div class="settings__nav-item active" data-pane="appearance">
                <i class="fas fa-palette"></i> Aparência
            </div>
            <div class="settings__nav-item" data-pane="account">
                <i class="fas fa-user-circle"></i> Conta
            </div>
        </div>
        <div class="settings__content">
            <div class="settings__pane active" id="pane-appearance">
                <div class="settings__section">
                    <h3>Tema</h3>
                    <p>Alterne entre os modos claro e escuro.</p>
                    <label class="switch" style="margin-top:10px;">
                      <input type="checkbox" id="settings-dark-mode-toggle">
                      <span class="slider round"></span>
                    </label>
                </div>
                <div class="settings__section">
                    <h3>Cor de Destaque</h3>
                    <p>Personalize a cor principal da interface.</p>
                    <div class="settings__color-palette" id="settings-accent-palette" style="margin-top:10px;"></div>
                </div>
                 <div class="settings__section">
                    <h3>Papel de Parede</h3>
                    <p>Escolha uma imagem de fundo para sua área de trabalho.</p>
                    <button id="settings-wallpaper-btn" class="app-button secondary" style="margin-top:10px;"><i class="fas fa-image"></i> Alterar Papel de Parede</button>
                    <input type="file" id="wallpaper-input" accept="image/*" style="display:none">
                </div>
            </div>
            <div class="settings__pane" id="pane-account">
                 <div class="settings__section">
                    <h3>Perfil</h3>
                    <p>Email da conta: <strong id="settings-user-email"></strong></p>
                    <p>ID de Usuário: <code id="settings-user-id" style="font-size:0.8em; color: var(--text-secondary);"></code></p>
                </div>
                <div class="settings__section">
                    <h3>Segurança</h3>
                    <button id="settings-reset-password-btn" class="app-button secondary">Redefinir Senha</button>
                </div>
            </div>
        </div>
    </template>


    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, updateDoc, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // ===================================================
        // == ARQUITETURA PMOS 2.0 - CLASSES E CORE LÓGICO ==
        // ===================================================

        const ApiConfig = {
            firebase: {
                apiKey: "AIzaSyCbpWXt9stM8jnIL3UIggZuvr3V7nwvPcQ",
                authDomain: "publicmanagementos.firebaseapp.com",
                projectId: "publicmanagementos",
                storageBucket: "publicmanagementos.firebasestorage.app",
                messagingSenderId: "publicmanagementos.firebasestorage.app",
                appId: "1:829309037744:web:3276773141117bb8255f75",
            }
        };

        const STORAGE_KEYS = {
            WALLPAPER: 'pmos_wallpaper_v2.0',
            THEME_DARK_MODE: 'pmos_dark_mode_v2.0',
            THEME_ACCENT_COLOR: 'pmos_accent_color_v2.0',
        };
        
        const APP_REGISTRY = {}; // Será populado com as classes dos aplicativos

        /**
         * Gera um ID único para elementos e arquivos.
         * @param {string} prefix - O prefixo do ID.
         * @returns {string} - Um ID único.
         */
        const generateId = (prefix = 'id') => `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        /**
         * Um simples sistema de Event Bus para comunicação desacoplada entre componentes.
         */
        class EventBus {
            constructor() {
                this.events = {};
            }

            on(eventName, listener) {
                if (!this.events[eventName]) {
                    this.events[eventName] = [];
                }
                this.events[eventName].push(listener);
            }

            emit(eventName, data) {
                if (this.events[eventName]) {
                    this.events[eventName].forEach(listener => listener(data));
                }
            }
        }

        /**
         * Gerencia a autenticação com o Firebase.
         */
        class AuthManager {
            constructor(os) {
                this.os = os;
                this.firebaseApp = initializeApp(ApiConfig.firebase);
                this.auth = getAuth(this.firebaseApp);
                this.db = getFirestore(this.firebaseApp);
                this.user = null;
            }

            init() {
                onAuthStateChanged(this.auth, this.handleAuthState.bind(this));
                
                document.getElementById('login-btn').onclick = () => this.signIn();
                document.getElementById('register-btn').onclick = () => this.register();
                document.getElementById('logout-btn').onclick = () => this.signOut();
                document.getElementById('forgot-password-link').onclick = (e) => {
                    e.preventDefault();
                    this.sendPasswordReset();
                };
            }

            async signIn() {
                const email = document.getElementById('email-input').value;
                const password = document.getElementById('password-input').value;
                const errorEl = document.getElementById('login-error');
                try {
                    errorEl.style.display = 'none';
                    await signInWithEmailAndPassword(this.auth, email, password);
                } catch (error) {
                    errorEl.textContent = "E-mail ou senha inválidos.";
                    errorEl.style.display = 'block';
                }
            }

            async register() {
                const email = document.getElementById('email-input').value;
                const password = document.getElementById('password-input').value;
                const errorEl = document.getElementById('login-error');
                errorEl.style.display = 'none';

                if (password.length < 6) {
                    errorEl.textContent = "A senha deve ter pelo menos 6 caracteres.";
                    errorEl.style.display = 'block';
                    return;
                }

                try {
                    await createUserWithEmailAndPassword(this.auth, email, password);
                } catch (error) {
                    errorEl.textContent = error.code === 'auth/email-already-in-use' 
                        ? "Este e-mail já está em uso." 
                        : "Erro ao criar conta.";
                    errorEl.style.display = 'block';
                }
            }

            async sendPasswordReset() {
                const email = document.getElementById('email-input').value;
                if (!email) {
                    this.os.notificationManager.show("Digite seu e-mail para redefinir a senha.", 'warning');
                    return;
                }
                try {
                    await sendPasswordResetEmail(this.auth, email);
                    this.os.notificationManager.show(`E-mail de redefinição enviado para ${email}.`, 'success');
                } catch (error) {
                    this.os.notificationManager.show("Não foi possível enviar o e-mail.", 'error');
                }
            }

            signOut() {
                if (this.os.windowManager.hasUnsavedChanges()) {
                    if (!confirm("Você possui alterações não salvas. Deseja sair e descartá-las?")) {
                        return;
                    }
                }
                signOut(this.auth);
            }

            handleAuthState(user) {
                if (user) {
                    this.user = user;
                    document.body.classList.remove('logged-out');
                    document.body.classList.add('logged-in');
                    this.os.start(user, this.db);
                } else {
                    this.user = null;
                    document.body.classList.add('logged-out');
                    document.body.classList.remove('logged-in');
                    this.os.shutdown();
                }
            }
        }

        /**
         * Gerencia a interação com o Firestore (Sistema de Arquivos).
         * Versão 2.0 com suporte a pastas.
         */
        class FirestoreManager {
            constructor(db, userId) {
                this.db = db;
                this.userId = userId;
                this.filesCollection = collection(db, `users/${this.userId}/files`);
            }

            /**
             * Lista arquivos e pastas em um diretório pai.
             * @param {string|null} parentId - O ID da pasta pai (null para a raiz).
             * @returns {Promise<Array>} - Uma lista de arquivos e pastas.
             */
            async list(parentId = null) {
                try {
                    const q = query(this.filesCollection, where("parentId", "==", parentId));
                    const querySnapshot = await getDocs(q);
                    const items = [];
                    querySnapshot.forEach((doc) => {
                        items.push({ id: doc.id, ...doc.data() });
                    });
                    items.sort((a, b) => (a.type === 'folder' ? -1 : 1) - (b.type === 'folder' ? -1 : 1) || a.name.localeCompare(b.name));
                    return items;
                } catch (error) {
                    console.error("Erro ao listar itens:", error);
                    throw new Error("Não foi possível carregar os itens da nuvem.");
                }
            }

            async get(fileId) {
                const docRef = doc(this.filesCollection, fileId);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) throw new Error("Arquivo não encontrado.");
                return { id: docSnap.id, ...docSnap.data() };
            }

            async save(fileMetadata, content) {
                const docId = fileMetadata.id || generateId('file');
                const docRef = doc(this.filesCollection, docId);
                
                const dataToSave = {
                    id: docId,
                    name: fileMetadata.name,
                    appId: fileMetadata.appId,
                    type: 'file', // 'file' ou 'folder'
                    parentId: fileMetadata.parentId || null,
                    content: content, // Salva o objeto diretamente
                    modifiedAt: Date.now()
                };

                await setDoc(docRef, dataToSave, { merge: true });
                return dataToSave;
            }
            
            async createFolder(name, parentId = null) {
                const folderId = generateId('folder');
                const docRef = doc(this.filesCollection, folderId);
                const folderData = {
                    id: folderId,
                    name: name,
                    type: 'folder',
                    parentId: parentId,
                    createdAt: Date.now()
                };
                await setDoc(docRef, folderData);
                return folderData;
            }

            async rename(itemId, newName) {
                const docRef = doc(this.filesCollection, itemId);
                await updateDoc(docRef, { name: newName, modifiedAt: Date.now() });
            }

            async delete(itemId) {
                const itemToDelete = await this.get(itemId);

                // Se for uma pasta, deleta todo o conteúdo recursivamente
                if (itemToDelete.type === 'folder') {
                    const allChildren = await this.getAllChildren(itemId);
                    const batch = writeBatch(this.db);
                    allChildren.forEach(childId => {
                        batch.delete(doc(this.filesCollection, childId));
                    });
                    batch.delete(doc(this.filesCollection, itemId));
                    await batch.commit();
                } else {
                    await deleteDoc(doc(this.filesCollection, itemId));
                }
            }

            async getAllChildren(folderId) {
                const children = [];
                const q = query(this.filesCollection, where("parentId", "==", folderId));
                const snapshot = await getDocs(q);
                
                for(const doc of snapshot.docs) {
                    children.push(doc.id);
                    if (doc.data().type === 'folder') {
                        const subChildren = await this.getAllChildren(doc.id);
                        children.push(...subChildren);
                    }
                }
                return children;
            }
        }
        
        /**
         * Gerencia o estado e a renderização do Dock.
         */
        class Dock {
            constructor(os, containerId, apps) {
                this.os = os;
                this.container = document.getElementById(containerId);
                this.apps = apps;
                
                this.os.eventBus.on('window:opened', (win) => this.updateActiveState(win.app.id));
                this.os.eventBus.on('window:closed', () => this.updateActiveState(null));
                this.os.eventBus.on('window:focused', (win) => this.updateActiveState(win.app.id));
            }

            render() {
                this.container.innerHTML = '';
                this.apps.forEach(app => {
                    if (!app.showInDock) return;
                    
                    const item = document.createElement('div');
                    item.className = 'dock__item';
                    item.title = app.name;
                    item.innerHTML = `<i class="${app.icon}"></i>`;
                    item.dataset.appId = app.id;
                    item.onclick = () => this.os.launch(app.id);
                    this.container.appendChild(item);
                });
            }

            updateActiveState(activeAppId) {
                this.container.querySelectorAll('.dock__item').forEach(item => {
                    const running = this.os.windowManager.isAppRunning(item.dataset.appId);
                    const active = item.dataset.appId === activeAppId;
                    item.classList.toggle('active', running);
                    // Aqui poderia adicionar uma animação diferente se 'active' vs 'running'
                });
            }
        }

        /**
         * Gerencia o estado e a renderização da barra de tarefas.
         */
        class Taskbar {
            constructor(os, containerId) {
                this.os = os;
                this.container = document.getElementById(containerId);
                this.clockEl = document.getElementById('clock');
                
                this.os.eventBus.on('window:opened', this.render.bind(this));
                this.os.eventBus.on('window:closed', this.render.bind(this));
                this.os.eventBus.on('window:focused', this.render.bind(this));
                this.os.eventBus.on('window:titleChanged', this.render.bind(this));
            }
            
            init() {
                this.updateClock();
                setInterval(() => this.updateClock(), 15000);
            }

            updateClock() {
                this.clockEl.textContent = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            }

            render() {
                this.container.innerHTML = '';
                const windows = this.os.windowManager.getWindows();
                windows.forEach(win => {
                    const item = document.createElement('div');
                    item.className = 'taskbar__item';
                    item.classList.toggle('active', this.os.windowManager.isActive(win.id));
                    item.innerHTML = `<i class="icon ${win.app.icon}"></i> <span class="taskbar__item-title">${win.title}</span>`;
                    
                    item.onclick = () => {
                        if (this.os.windowManager.isActive(win.id) && !win.minimized) {
                            this.os.windowManager.minimize(win.id);
                        } else {
                            this.os.windowManager.focus(win.id);
                        }
                    };
                    
                    this.container.appendChild(item);
                });
            }
        }

        /**
         * Gerencia janelas (criação, manipulação, estado).
         */
        class WindowManager {
            constructor(os) {
                this.os = os;
                this.windows = new Map();
                this.activeWindowId = null;
                this.zIndexCounter = 100;
                this.desktop = document.getElementById('desktop');
            }

            create(app, options = {}) {
                const winId = generateId('win');
                this.zIndexCounter++;

                const winEl = document.createElement('div');
                winEl.id = winId;
                winEl.className = 'window opening';
                winEl.style.width = options.width || '800px';
                winEl.style.height = options.height || '600px';
                winEl.style.zIndex = this.zIndexCounter;
                
                const maxLeft = window.innerWidth - parseInt(winEl.style.width, 10) - 20;
                const maxTop = window.innerHeight - parseInt(winEl.style.height, 10) - 60;
                winEl.style.left = `${Math.max(20, Math.random() * maxLeft)}px`;
                winEl.style.top = `${Math.max(60, Math.random() * maxTop)}px`;

                winEl.innerHTML = `
                    <div class="window__titlebar">
                        <div class="window__controls">
                            <button class="window-control close" data-action="close"></button>
                            <button class="window-control minimize" data-action="minimize"></button>
                            <button class="window-control maximize" data-action="maximize"></button>
                        </div>
                        <span class="window__title-text">${app.name}</span>
                    </div>
                    <div class="window__content"></div>
                    <div class="window__resize-handle"></div>
                `;

                this.desktop.appendChild(winEl);
                
                // Remove a animação após a conclusão
                setTimeout(() => winEl.classList.remove('opening'), 500);

                const windowInstance = {
                    id: winId,
                    el: winEl,
                    app: app,
                    title: app.name,
                    minimized: false,
                    maximized: false,
                    originalRect: null
                };

                this.windows.set(winId, windowInstance);
                this.focus(winId);
                this.initEventListeners(windowInstance);
                
                this.os.eventBus.emit('window:opened', windowInstance);
                
                return windowInstance;
            }

            initEventListeners(win) {
                const titlebar = win.el.querySelector('.window__titlebar');

                // Ações dos controles
                titlebar.addEventListener('click', (e) => {
                    const action = e.target.dataset.action;
                    if (action === 'close') this.close(win.id);
                    else if (action === 'minimize') this.minimize(win.id);
                    else if (action === 'maximize') this.maximize(win.id);
                });
                
                // Foco
                win.el.addEventListener('mousedown', () => this.focus(win.id), true);

                // Arrastar
                let offsetX, offsetY;
                titlebar.onmousedown = (e) => {
                    if (e.target.classList.contains('window-control')) return;
                    if (win.maximized) return;
                    
                    offsetX = e.clientX - win.el.offsetLeft;
                    offsetY = e.clientY - win.el.offsetTop;
                    document.body.classList.add('dragging');
                    win.el.classList.add('dragging');

                    const onMouseMove = (moveEvent) => {
                        win.el.style.left = `${moveEvent.clientX - offsetX}px`;
                        win.el.style.top = `${moveEvent.clientY - offsetY}px`;
                    };

                    const onMouseUp = () => {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                        document.body.classList.remove('dragging');
                        win.el.classList.remove('dragging');
                    };

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                };

                // Redimensionar
                const resizeHandle = win.el.querySelector('.window__resize-handle');
                resizeHandle.onmousedown = (e) => {
                    e.preventDefault();
                    if (win.maximized) return;

                    const startX = e.clientX;
                    const startY = e.clientY;
                    const startWidth = win.el.offsetWidth;
                    const startHeight = win.el.offsetHeight;
                    document.body.classList.add('resizing');

                    const onMouseMove = (moveEvent) => {
                        win.el.style.width = `${startWidth + moveEvent.clientX - startX}px`;
                        win.el.style.height = `${startHeight + moveEvent.clientY - startY}px`;
                    };

                     const onMouseUp = () => {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                        document.body.classList.remove('resizing');
                    };

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                };
            }

            focus(winId) {
                if (!this.windows.has(winId)) return;
                
                if (this.activeWindowId && this.windows.has(this.activeWindowId)) {
                    this.windows.get(this.activeWindowId).el.classList.remove('active');
                }
                
                const win = this.windows.get(winId);
                if (win.minimized) {
                    this.restore(winId);
                }
                
                this.zIndexCounter++;
                win.el.style.zIndex = this.zIndexCounter;
                win.el.classList.add('active');
                this.activeWindowId = winId;

                this.os.eventBus.emit('window:focused', win);
            }

            close(winId) {
                if (!this.windows.has(winId)) return;
                
                const win = this.windows.get(winId);
                
                // Verifica se há alterações não salvas
                if (win.app && typeof win.app.isDirty === 'function' && win.app.isDirty()) {
                    if (!confirm("Você possui alterações não salvas. Deseja fechar e descartar?")) {
                        return;
                    }
                }
                
                if (win.app && typeof win.app.onClose === 'function') {
                    win.app.onClose();
                }

                win.el.remove();
                this.windows.delete(winId);
                
                if (this.activeWindowId === winId) {
                    this.activeWindowId = null;
                }

                this.os.eventBus.emit('window:closed', win);
            }
            
            minimize(winId) {
                const win = this.windows.get(winId);
                if (!win) return;
                win.el.classList.add('minimized');
                win.minimized = true;
                this.os.eventBus.emit('window:minimized', win);
            }
            
            restore(winId) {
                 const win = this.windows.get(winId);
                if (!win) return;
                win.el.classList.remove('minimized');
                win.minimized = false;
                this.focus(winId);
            }
            
            maximize(winId) {
                const win = this.windows.get(winId);
                if (!win) return;

                if (win.maximized) { // Restaurar
                    win.el.classList.remove('maximized');
                    Object.assign(win.el.style, win.originalRect);
                    win.maximized = false;
                } else { // Maximizar
                    win.originalRect = {
                        top: win.el.style.top,
                        left: win.el.style.left,
                        width: win.el.style.width,
                        height: win.el.style.height,
                    };
                    win.el.classList.add('maximized');
                    win.maximized = true;
                }
                this.os.eventBus.emit('window:maximized', win);
            }

            isAppRunning(appId) {
                for (const win of this.windows.values()) {
                    if (win.app.id === appId) return true;
                }
                return false;
            }
            
            hasUnsavedChanges() {
                 for (const win of this.windows.values()) {
                    if (win.app && typeof win.app.isDirty === 'function' && win.app.isDirty()) {
                        return true;
                    }
                }
                return false;
            }
            
            getWindows() { return Array.from(this.windows.values()); }
            getWindow(winId) { return this.windows.get(winId); }
            isActive(winId) { return this.activeWindowId === winId; }
            
            updateWindowTitle(winId, newTitle) {
                const win = this.windows.get(winId);
                if (!win) return;
                win.title = newTitle;
                win.el.querySelector('.window__title-text').textContent = newTitle;
                this.os.eventBus.emit('window:titleChanged', win);
            }
        }
        
        /**
         * Gerencia o tema da UI (claro/escuro, cor de destaque).
         */
        class ThemeManager {
            constructor(os) {
                this.os = os;
                this.isDark = localStorage.getItem(STORAGE_KEYS.THEME_DARK_MODE) === 'true';
                this.accentColor = localStorage.getItem(STORAGE_KEYS.THEME_ACCENT_COLOR) || '#007AFF';
                this.palettes = {
                    light: ["#007AFF", "#FF2D55", "#34C759", "#FF9500", "#AF52DE", "#FFCC00", "#8E8E93"],
                    dark: ["#0A84FF", "#FF375F", "#30D158", "#FF9F0A", "#BF5AF2", "#FFD60A", "#98989D"]
                };
            }

            init() {
                if (this.isDark) {
                    document.body.classList.add('dark-mode');
                }
                this.setAccentColor(this.accentColor);
                
                const wallpaper = localStorage.getItem(STORAGE_KEYS.WALLPAPER);
                if (wallpaper) {
                    document.body.style.backgroundImage = `url(${wallpaper})`;
                }
            }
            
            toggleDarkMode(isDark) {
                this.isDark = isDark;
                document.body.classList.toggle('dark-mode', this.isDark);
                localStorage.setItem(STORAGE_KEYS.THEME_DARK_MODE, this.isDark);
                this.os.eventBus.emit('theme:changed', this);
            }

            setAccentColor(color) {
                this.accentColor = color;
                document.documentElement.style.setProperty('--accent', color);
                
                // Converte hex para RGB para usar em 'rgba'
                let r=0, g=0, b=0;
                if (color.startsWith('#')) {
                    r = parseInt(color.slice(1, 3), 16);
                    g = parseInt(color.slice(3, 5), 16);
                    b = parseInt(color.slice(5, 7), 16);
                }
                document.documentElement.style.setProperty('--accent-rgb', `${r}, ${g}, ${b}`);
                document.documentElement.style.setProperty('--accent-translucent', `rgba(${r},${g},${b}, ${this.isDark ? 0.2 : 0.15})`);
                
                localStorage.setItem(STORAGE_KEYS.THEME_ACCENT_COLOR, color);
                this.os.eventBus.emit('theme:changed', this);
            }
            
            setWallpaper(dataUrl) {
                document.body.style.backgroundImage = `url(${dataUrl})`;
                localStorage.setItem(STORAGE_KEYS.WALLPAPER, dataUrl);
            }
        }

        /**
         * Gerencia notificações.
         */
        class NotificationManager {
            constructor() {
                this.container = document.getElementById('notification-center');
            }
            
            show(message, type = 'info', duration = 4000) {
                const notification = document.createElement('div');
                notification.className = `notification notification--${type}`;
                notification.textContent = message;
                
                this.container.appendChild(notification);
                
                // Força o reflow para a animação funcionar
                requestAnimationFrame(() => {
                    notification.classList.add('show');
                });

                setTimeout(() => {
                    notification.classList.remove('show');
                    notification.addEventListener('transitionend', () => notification.remove());
                }, duration);
            }
        }

        /**
         * Classe base para todos os aplicativos. Define a interface padrão.
         */
        class AppComponent {
            constructor(os, win, options = {}) {
                this.os = os;
                this.win = win; // Instância da janela
                this.win.app = this;
                this.contentEl = this.win.el.querySelector('.window__content');
                this.file = null; // { id, name, ... }
                this._isDirty = false;
            }

            // A ser implementado pelas subclasses
            render() { throw new Error("O método 'render' deve ser implementado."); }
            initEventListeners() {}
            getData() { return null; }
            loadData(fileData) { throw new Error("O método 'loadData' deve ser implementado."); }
            onClose() {}

            isDirty() { return this._isDirty; }

            markDirty() {
                if (!this._isDirty) {
                    this._isDirty = true;
                    this.updateTitleWithDirtyIndicator();
                }
            }

            markClean() {
                this._isDirty = false;
                this.updateTitleWithDirtyIndicator();
            }

            updateTitleWithDirtyIndicator() {
                let currentTitle = this.win.title.replace('*', '').trim();
                if (this._isDirty) {
                    this.os.windowManager.updateWindowTitle(this.win.id, `* ${currentTitle}`);
                } else {
                    this.os.windowManager.updateWindowTitle(this.win.id, currentTitle);
                }
            }

            async save() {
                if (!this.file || !this.file.id) {
                    await this.saveAs();
                    return;
                }
                
                this.os.notificationManager.show(`Salvando "${this.file.name}"...`);
                try {
                    const content = this.getData();
                    const fileMetadata = { ...this.file };
                    await this.os.firestoreManager.save(fileMetadata, content);
                    this.markClean();
                    this.os.notificationManager.show(`"${this.file.name}" salvo com sucesso!`, 'success');
                } catch (error) {
                    console.error("Erro ao salvar:", error);
                    this.os.notificationManager.show("Falha ao salvar o arquivo.", 'error');
                }
            }

            async saveAs() {
                const newName = prompt("Salvar como:", this.file?.name || `Novo ${this.constructor.appName}.json`);
                if (!newName) return;

                const content = this.getData();
                const fileMetadata = {
                    name: newName,
                    appId: this.constructor.appId,
                    parentId: this.file?.parentId || this.os.fileExplorer.currentFolderId // Salva na pasta atual
                };

                try {
                    const savedFile = await this.os.firestoreManager.save(fileMetadata, content);
                    this.file = savedFile; // Atualiza o arquivo atual
                    this.os.windowManager.updateWindowTitle(this.win.id, savedFile.name);
                    this.markClean();
                    this.os.notificationManager.show(`"${savedFile.name}" salvo com sucesso!`, 'success');
                } catch (error) {
                    console.error("Erro ao salvar como:", error);
                    this.os.notificationManager.show("Falha ao salvar o arquivo.", 'error');
                }
            }
        }

        // ===================================
        // == APLICATIVOS (IMPLEMENTAÇÕES) ==
        // ===================================
        
        /**
         * Aplicativo: File Explorer
         */
        class FileExplorerApp extends AppComponent {
            static appId = 'FileExplorer';
            static appName = 'Explorador de Arquivos';
            static icon = 'fas fa-folder-open';
            static showInDock = true;
            
            constructor(os, win) {
                super(os, win);
                this.currentFolderId = null;
                this.path = [{ id: null, name: 'Raiz' }];
            }

            render() {
                const template = document.getElementById('template-app-file-explorer');
                this.contentEl.innerHTML = template.innerHTML;
                this.gridEl = this.contentEl.querySelector('.file-explorer__grid');
                this.breadcrumbEl = this.contentEl.querySelector('#breadcrumb');
                this.initEventListeners();
                this.loadFolder(this.currentFolderId);
            }

            initEventListeners() {
                // Toolbar actions
                this.contentEl.querySelector('button[data-action="refresh"]').onclick = () => this.loadFolder(this.currentFolderId);
                this.contentEl.querySelector('button[data-action="create-folder"]').onclick = () => this.createFolder();
                this.contentEl.querySelector('button[data-action="go-back"]').onclick = () => this.goBack();

                // Grid actions
                this.gridEl.addEventListener('dblclick', (e) => {
                    const itemEl = e.target.closest('.file-explorer__item');
                    if (!itemEl) return;
                    const item = JSON.parse(itemEl.dataset.item);
                    if (item.type === 'folder') {
                        this.loadFolder(item.id);
                    } else {
                        this.os.launch(item.appId, { fileId: item.id });
                    }
                });
            }

            async loadFolder(folderId) {
                this.currentFolderId = folderId;
                
                // Update path
                if(folderId){
                    const folder = await this.os.firestoreManager.get(folderId);
                    // Check if we are moving forward or backward in path
                    const existingIndex = this.path.findIndex(p => p.id === folderId);
                    if (existingIndex !== -1) {
                        this.path.splice(existingIndex + 1);
                    } else {
                        this.path.push(folder);
                    }
                } else {
                    this.path = [{ id: null, name: 'Raiz' }];
                }
                this.renderBreadcrumb();

                this.gridEl.innerHTML = '<p>Carregando...</p>';
                try {
                    const items = await this.os.firestoreManager.list(folderId);
                    this.renderGrid(items);
                } catch (error) {
                    this.os.notificationManager.show(error.message, 'error');
                }
            }
            
            goBack() {
                if (this.path.length > 1) {
                    this.path.pop();
                    const previousFolder = this.path[this.path.length - 1];
                    this.loadFolder(previousFolder.id);
                }
            }

            renderBreadcrumb() {
                this.breadcrumbEl.textContent = this.path.map(p => p.name).join(' / ');
            }

            renderGrid(items) {
                this.gridEl.innerHTML = '';
                if (items.length === 0) {
                    this.gridEl.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary);">Esta pasta está vazia.</p>';
                    return;
                }
                items.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'file-explorer__item';
                    itemEl.dataset.item = JSON.stringify(item);
                    
                    let iconClass;
                    if (item.type === 'folder') {
                        iconClass = 'fas fa-folder';
                    } else {
                        const app = this.os.getAppInfo(item.appId);
                        iconClass = app?.icon || 'fas fa-file';
                    }

                    itemEl.innerHTML = `
                        <div class="file-explorer__item-icon"><i class="${iconClass}"></i></div>
                        <div class="file-explorer__item-name">${item.name}</div>
                    `;
                    this.gridEl.appendChild(itemEl);
                });
            }
            
            async createFolder() {
                const name = prompt("Nome da nova pasta:");
                if (name) {
                    try {
                        await this.os.firestoreManager.createFolder(name, this.currentFolderId);
                        this.loadFolder(this.currentFolderId);
                    } catch (error) {
                        this.os.notificationManager.show("Erro ao criar pasta.", 'error');
                    }
                }
            }
        }
        
        /**
         * Aplicativo: BPMN Modeler (Visual)
         */
        class BpmnModelerApp extends AppComponent {
            static appId = 'BPMNModeler';
            static appName = 'Modelador BPMN';
            static icon = 'fas fa-project-diagram';
            static showInDock = true;
            
            constructor(os, win) {
                super(os, win, { width: '1000px', height: '750px' });
                this.bpmnModeler = null;
                this.initialDiagram = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" targetNamespace="http://bpmn.io/schema/bpmn" id="Definitions_1">
  <bpmn:process id="Process_1" isExecutable="false">
    <bpmn:startEvent id="StartEvent_1"/>
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
      <bpmndi:BPMNShape id="_BPMNShape_StartEvent_2" bpmnElement="StartEvent_1">
        <dc:Bounds x="173" y="102" width="36" height="36" />
      </bpmndi:BPMNShape>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>`;
            }

            render() {
                const template = document.getElementById('template-app-bpmn-modeler');
                this.contentEl.innerHTML = template.innerHTML;
                const canvas = this.contentEl.querySelector('.bpmn-canvas');

                this.bpmnModeler = new BpmnJS({ container: canvas });
                
                this.bpmnModeler.on('commandStack.changed', () => this.markDirty());
                
                this.initEventListeners();
                this.loadData(this.initialDiagram);
            }
            
            initEventListeners() {
                const toolbar = this.contentEl.querySelector('.app-toolbar');
                toolbar.querySelector('[data-action="save"]').onclick = () => this.save();
                toolbar.querySelector('[data-action="save-as"]').onclick = () => this.saveAs();
                toolbar.querySelector('[data-action="export-svg"]').onclick = () => this.exportSVG();
            }

            async loadData(fileData) {
                const xml = fileData?.content || this.initialDiagram;
                try {
                    await this.bpmnModeler.importXML(xml);
                    if (fileData) {
                        this.file = fileData;
                        this.os.windowManager.updateWindowTitle(this.win.id, this.file.name);
                    }
                    this.markClean();
                } catch (err) {
                    console.error('Erro ao carregar diagrama BPMN:', err);
                    this.os.notificationManager.show('Arquivo BPMN inválido ou corrompido.', 'error');
                }
            }
            
            async getData() {
                try {
                    const { xml } = await this.bpmnModeler.saveXML({ format: true });
                    return xml;
                } catch (err) {
                    console.error("Erro ao serializar BPMN para XML:", err);
                    return null;
                }
            }
            
            async exportSVG() {
                try {
                    const { svg } = await this.bpmnModeler.saveSVG();
                    const encodedSvg = encodeURIComponent(svg);
                    const link = document.createElement('a');
                    link.download = `${this.file?.name || 'diagrama'}.svg`;
                    link.href = 'data:image/svg+xml;charset=UTF-8,' + encodedSvg;
                    link.click();
                } catch (err) {
                    this.os.notificationManager.show('Falha ao exportar SVG.', 'error');
                }
            }
            
            onClose() {
                if (this.bpmnModeler) {
                    this.bpmnModeler.destroy();
                }
            }
        }
        
        /**
         * Aplicativo: Ishikawa (Visual)
         */
        class IshikawaDiagramApp extends AppComponent {
            static appId = 'IshikawaDiagram';
            static appName = 'Diagrama de Ishikawa';
            static icon = 'fas fa-fish';
            static showInDock = true;
            
            constructor(os, win) {
                super(os, win, { width: '950px', height: '700px' });
                this.data = this.getDefaultData();
            }

            getDefaultData() {
                return {
                    effect: { text: "Problema Central", x: 800, y: 300 },
                    categories: [
                        { text: "Método", x: 200, y: 100, causes: [] },
                        { text: "Máquina", x: 500, y: 100, causes: [] },
                        { text: "Mão-de-Obra", x: 800, y: 100, causes: [] },
                        { text: "Material", x: 200, y: 500, causes: [] },
                        { text: "Medição", x: 500, y: 500, causes: [] },
                        { text: "Meio Ambiente", x: 800, y: 500, causes: [] },
                    ]
                };
            }

            render() {
                const template = document.getElementById('template-app-ishikawa-diagram');
                this.contentEl.innerHTML = template.innerHTML;
                this.viewport = this.contentEl.querySelector('.ishikawa-diagram__viewport');
                this.svg = this.contentEl.querySelector('.ishikawa-diagram__svg');
                this.initEventListeners();
                this.renderDiagram();
            }

            loadData(fileData) {
                this.data = fileData?.content || this.getDefaultData();
                this.file = fileData;
                if(fileData) this.os.windowManager.updateWindowTitle(this.win.id, fileData.name);
                this.markClean();
                this.renderDiagram();
            }

            getData() { return this.data; }

            renderDiagram() {
                this.svg.innerHTML = this.svg.querySelector('defs').outerHTML; // Clear SVG but keep defs
                const { effect, categories } = this.data;

                // Spine
                const spine = this.createSVGElement('line', { x1: 50, y1: effect.y, x2: effect.x, y2: effect.y, class: 'spine' });
                this.svg.appendChild(spine);

                // Effect
                this.createLabel(effect, 'effect', `effect-node`);

                // Categories and Causes
                categories.forEach((cat, catIndex) => {
                    this.createBranch(cat.x, cat.y, effect.y, `cat-branch-${catIndex}`);
                    this.createLabel(cat, 'category', `cat-label-${catIndex}`);
                    
                    cat.causes.forEach((cause, causeIndex) => {
                       this.createBranch(cause.x, cause.y, cat.y, `cause-branch-${catIndex}-${causeIndex}`, cat.x);
                       this.createLabel(cause, 'cause', `cause-label-${catIndex}-${causeIndex}`);
                    });
                });

                this.makeDraggable();
            }
            
            createSVGElement(tag, attrs) {
                const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
                for (const key in attrs) {
                    el.setAttribute(key, attrs[key]);
                }
                return el;
            }

            createBranch(x, y, spineY, id, parentX) {
                const isSubBranch = parentX !== undefined;
                const line = this.createSVGElement('line', {
                    x1: isSubBranch ? parentX : x,
                    y1: isSubBranch ? spineY : y,
                    x2: x,
                    y2: isSubBranch ? y : spineY,
                    class: 'branch',
                    id: id
                });
                this.svg.appendChild(line);
            }

            createLabel(node, type, id) {
                const g = this.createSVGElement('g', { class: 'label-group', 'data-id': id });
                const text = this.createSVGElement('text', {
                    x: node.x, y: node.y,
                    class: `label-text ${type}`,
                    'text-anchor': 'middle',
                    'dominant-baseline': 'middle'
                });
                text.textContent = node.text;
                
                // Add a transparent box for easier clicking
                const bbox = this.getBBox(text);
                const rect = this.createSVGElement('rect', {
                    x: bbox.x - 5, y: bbox.y - 2,
                    width: bbox.width + 10, height: bbox.height + 4,
                    class: 'label-box',
                    rx: 4
                });
                
                g.appendChild(rect);
                g.appendChild(text);
                this.svg.appendChild(g);

                // Double click to edit
                g.ondblclick = () => {
                    const newText = prompt(`Editar ${type}:`, node.text);
                    if (newText !== null) {
                        node.text = newText;
                        this.renderDiagram();
                        this.markDirty();
                    }
                };
            }

            getBBox(textEl) {
                this.svg.appendChild(textEl);
                const bbox = textEl.getBBox();
                textEl.remove();
                return bbox;
            }

            initEventListeners() {
                const toolbar = this.contentEl.querySelector('.app-toolbar');
                toolbar.querySelector('[data-action="save"]').onclick = () => this.save();
                toolbar.querySelector('[data-action="save-as"]').onclick = () => this.saveAs();
                toolbar.querySelector('[data-action="add-cause"]').onclick = () => this.addCause();
            }
            
            addCause() {
                // Simplified: adds a cause to the first category
                const newCauseText = prompt("Nova causa:");
                if (!newCauseText) return;

                const cat = this.data.categories[0];
                cat.causes.push({ text: newCauseText, x: cat.x + 20, y: cat.y + 40});
                this.renderDiagram();
                this.markDirty();
            }
            
            // Simplified drag implementation
            makeDraggable() {
                // This is a complex feature. For this 2.0, we'll keep it simple.
                // A full implementation would handle SVG transforms, mouse coordinates, etc.
            }
        }
        
        /**
         * Aplicativo: Configurações
         */
        class SettingsApp extends AppComponent {
            static appId = 'Settings';
            static appName = 'Configurações';
            static icon = 'fas fa-cog';
            static showInDock = true;
            
            constructor(os, win) {
                super(os, win, { width: '650px', height: '500px' });
            }

            render() {
                const template = document.getElementById('template-app-settings');
                this.contentEl.innerHTML = template.innerHTML;
                this.contentEl.style.padding = '0'; // Custom padding in template
                
                this.initEventListeners();
                this.updateUI();
            }

            initEventListeners() {
                const navItems = this.contentEl.querySelectorAll('.settings__nav-item');
                navItems.forEach(item => {
                    item.onclick = () => {
                        navItems.forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        this.contentEl.querySelectorAll('.settings__pane').forEach(p => p.classList.remove('active'));
                        this.contentEl.querySelector(`#pane-${item.dataset.pane}`).classList.add('active');
                    }
                });
                
                // Appearance
                this.contentEl.querySelector('#settings-dark-mode-toggle').onchange = (e) => this.os.themeManager.toggleDarkMode(e.target.checked);
                this.contentEl.querySelector('#settings-wallpaper-btn').onclick = () => this.contentEl.querySelector('#wallpaper-input').click();
                this.contentEl.querySelector('#wallpaper-input').onchange = (e) => this.handleWallpaperChange(e);
                
                // Account
                this.contentEl.querySelector('#settings-reset-password-btn').onclick = () => this.os.authManager.sendPasswordReset();
            }

            updateUI() {
                // Appearance
                const tm = this.os.themeManager;
                this.contentEl.querySelector('#settings-dark-mode-toggle').checked = tm.isDark;
                const paletteContainer = this.contentEl.querySelector('#settings-accent-palette');
                paletteContainer.innerHTML = '';
                const currentPalette = tm.isDark ? tm.palettes.dark : tm.palettes.light;
                currentPalette.forEach(color => {
                    const option = document.createElement('div');
                    option.className = 'settings__color-option';
                    option.style.backgroundColor = color;
                    if (color === tm.accentColor) {
                        option.classList.add('selected');
                    }
                    option.onclick = () => tm.setAccentColor(color);
                    paletteContainer.appendChild(option);
                });

                // Account
                const user = this.os.authManager.user;
                if (user) {
                    this.contentEl.querySelector('#settings-user-email').textContent = user.email;
                    this.contentEl.querySelector('#settings-user-id').textContent = user.uid;
                }
            }
            
            handleWallpaperChange(e) {
                const file = e.target.files[0];
                if (!file || !file.type.startsWith('image/')) return;
                const reader = new FileReader();
                reader.onload = (event) => this.os.themeManager.setWallpaper(event.target.result);
                reader.readAsDataURL(file);
            }
        }
        
        /**
         * Classe principal do Sistema Operacional.
         * Orquestra todos os outros componentes.
         */
        class PublicManagementOS {
            constructor() {
                this.eventBus = new EventBus();
                this.authManager = new AuthManager(this);
                this.notificationManager = new NotificationManager();
                
                // Componentes da UI que serão inicializados após o login
                this.firestoreManager = null;
                this.windowManager = null;
                this.themeManager = null;
                this.dock = null;
                this.taskbar = null;
                this.fileExplorer = null; // Instância do app, para referência

                this.isInitialized = false;
            }
            
            boot() {
                this.authManager.init();
            }

            start(user, db) {
                if (this.isInitialized) return;
                
                // Inicializa os componentes principais
                this.firestoreManager = new FirestoreManager(db, user.uid);
                this.windowManager = new WindowManager(this);
                this.themeManager = new ThemeManager(this);
                
                this.themeManager.init();

                // Registra todos os aplicativos
                this.registerApp(FileExplorerApp);
                this.registerApp(BpmnModelerApp);
                this.registerApp(IshikawaDiagramApp);
                this.registerApp(SettingsApp);
                // ... registrar outros apps aqui...

                // Inicializa componentes da UI
                this.dock = new Dock(this, 'app-dock', Object.values(APP_REGISTRY));
                this.taskbar = new Taskbar(this, 'taskbar-tasks');
                this.dock.render();
                this.taskbar.init();
                
                // Atualiza UI com info do usuário
                const userProfileEl = document.getElementById('user-profile');
                userProfileEl.style.display = 'flex';
                document.getElementById('user-profile-name').textContent = user.email.split('@')[0];

                this.notificationManager.show(`Bem-vindo(a) ao PMOS 2.0, ${user.email.split('@')[0]}!`, 'success');
                this.isInitialized = true;
                
                this.launch('FileExplorer'); // Lança o explorador de arquivos ao iniciar
            }
            
            shutdown() {
                // Limpa a UI e reseta o estado
                if (!this.isInitialized) return;
                document.getElementById('desktop').innerHTML = '';
                document.getElementById('taskbar-tasks').innerHTML = '';
                document.getElementById('app-dock').innerHTML = '';
                this.windowManager = null;
                this.firestoreManager = null;
                this.isInitialized = false;
                window.location.reload(); // Maneira mais simples de garantir um estado limpo
            }

            registerApp(appClass) {
                APP_REGISTRY[appClass.appId] = {
                    id: appClass.appId,
                    name: appClass.appName,
                    icon: appClass.icon,
                    showInDock: appClass.showInDock,
                    class: appClass
                };
            }
            
            getAppInfo(appId) {
                return APP_REGISTRY[appId];
            }

            launch(appId, options = {}) {
                const appInfo = this.getAppInfo(appId);
                if (!appInfo) {
                    console.error(`Aplicativo "${appId}" não encontrado.`);
                    return;
                }
                
                const win = this.windowManager.create(appInfo, options);
                const appInstance = new appInfo.class(this, win, options);

                if (options.fileId) {
                    this.firestoreManager.get(options.fileId)
                        .then(fileData => appInstance.loadData(fileData))
                        .catch(err => this.notificationManager.show(`Erro ao abrir arquivo: ${err.message}`, 'error'));
                }
                
                appInstance.render();
                
                // Adiciona uma referência ao app explorer para uso por outros apps
                if (appId === 'FileExplorer') {
                    this.fileExplorer = appInstance;
                }
            }
        }

        // --- PONTO DE ENTRADA ---
        document.addEventListener('DOMContentLoaded', () => {
            const os = new PublicManagementOS();
            window.PMOS = os; // Torna acessível globalmente para depuração
            os.boot();
        });

    </script>
</body>
</html>
